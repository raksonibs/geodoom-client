<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Ember ERD</title>
    <meta name='description' content=''>
    <meta name='viewport' content='width=device-width', initial-scale='1'>
    <style>
      body,
      html {
        width: 100%;
        height: 100%;
      }

      .models {
        display: flex;
        flex-direction: row;
        overflow-x: scroll;
        flex-wrap: wrap;
      }

      .model {
        // display: inline-block;
        border: 1px solid black;
        width: 400px;
        // height: 200px;
        margin: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .model .name,
      .model .attrs,
      .model .relations {        
        width: 32%;
        display: inline-block;
        margin: 10px;
        z-index: 100;
      }

      .model .name,
      .model .attrs {
        border-right: 1px solid black;
        height: 100%;
      }

      .model .name {        
        font-weight: 900;
      }

      .model .attrs .attr-val {
        color: lightgrey;
        display: inline-block;
      }

      .arrow {
        position: absolute;
        background: black;
        width: 40px;
        height: 5px;
        transform-origin: 0% 50%;
        transition: all 100ms cubic-bezier(.8,.5,1,.8);
        /*border-radius: 50%/100px 100px 0 0;*/
        background-image/*: url("http://www.iconsdb.com/icons/preview/black/arrow-18-xxl.png");
        background-size: cover;
        background-posit*/ion: center;
        z-index: -1000;
      }

      .arrow:after {
        display: block;
        content:'';
        border-top: 7px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 14px solid black;
        transform: translate(40px, -5px);  
      }
    </style>
  </head>
  <body>
    <h1> Ember ERD Model Visualizer TEST3 </h1>
    <div class="models">
<div class="model" data-model="balanceChange" data-belongsTo="" data-hasMany="">
                              <div class="name">
                                balanceChange
                              </div>
                              <div class="attrs">
                                 changeType <span class='attr-val'>string</span><br />  entryDate <span class='attr-val'>string</span><br />  value <span class='attr-val'>number</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: 
                                <br />
                                hasMany: 
                              </div>
                            </div><div class="model" data-model="battle" data-belongsTo="state" data-hasMany="users pets">
                              <div class="name">
                                battle
                              </div>
                              <div class="attrs">
                                 winnerId <span class='attr-val'>number</span><br />  loserId <span class='attr-val'>number</span><br />  winnerEmail <span class='attr-val'>string</span><br />  loserEmail <span class='attr-val'>string</span><br />  name <span class='attr-val'>string</span><br />  challengedEmail <span class='attr-val'>string</span><br />  challengerEmail <span class='attr-val'>string</span><br />  status <span class='attr-val'>string</span><br />  challengerPetId <span class='attr-val'>string</span><br />  challengedPetId <span class='attr-val'>string</span><br />  challengerPet <span class='attr-val'></span><br />  challengedPet <span class='attr-val'></span><br />  currentTurn <span class='attr-val'>number</span><br />  currentTurnEmail <span class='attr-val'>string</span><br />  createdAt <span class='attr-val'>string</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: state
                                <br />
                                hasMany: users, pets
                              </div>
                            </div><div class="model" data-model="gameStat" data-belongsTo="user" data-hasMany="">
                              <div class="name">
                                gameStat
                              </div>
                              <div class="attrs">
                                 name <span class='attr-val'>string</span><br />  value <span class='attr-val'>number</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: user
                                <br />
                                hasMany: 
                              </div>
                            </div><div class="model" data-model="petState" data-belongsTo="state pet" data-hasMany="">
                              <div class="name">
                                petState
                              </div>
                              <div class="attrs">
                                 currentHealth <span class='attr-val'>number</span><br />  currentAttack <span class='attr-val'>number</span><br />  currentDefence <span class='attr-val'>number</span><br />  shield <span class='attr-val'>boolean</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: state, pet
                                <br />
                                hasMany: 
                              </div>
                            </div><div class="model" data-model="pet" data-belongsTo="user" data-hasMany="stats battles petStates">
                              <div class="name">
                                pet
                              </div>
                              <div class="attrs">
                                 name <span class='attr-val'>string</span><br />  level <span class='attr-val'>number</span><br />  vertices <span class='attr-val'>number</span><br />  colour <span class='attr-val'>string</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: user
                                <br />
                                hasMany: stats, battles, petStates
                              </div>
                            </div><div class="model" data-model="stat" data-belongsTo="pet" data-hasMany="">
                              <div class="name">
                                stat
                              </div>
                              <div class="attrs">
                                 statType <span class='attr-val'>string</span><br />  value <span class='attr-val'>number</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: pet
                                <br />
                                hasMany: 
                              </div>
                            </div><div class="model" data-model="state" data-belongsTo="battle" data-hasMany="petStates">
                              <div class="name">
                                state
                              </div>
                              <div class="attrs">
                                 name <span class='attr-val'>string</span><br />  currentTurn <span class='attr-val'>integer</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: battle
                                <br />
                                hasMany: petStates
                              </div>
                            </div><div class="model" data-model="user" data-belongsTo="" data-hasMany="pets battles gameStats">
                              <div class="name">
                                user
                              </div>
                              <div class="attrs">
                                 currency <span class='attr-val'>string</span><br />  email <span class='attr-val'>string</span><br />  uid <span class='attr-val'>string</span><br />  nickname <span class='attr-val'>string</span><br />  image <span class='attr-val'>string</span><br />  online <span class='attr-val'>boolean</span><br />
                              </div>
                              <div class="relations">
                                belongsTo: 
                                <br />
                                hasMany: pets, battles, gameStats
                              </div>
                            </div>                      
                      </div>
                      <script>
                      function angle(p1,p2) { 
                          var dx=p2.x-p1.x,
                              dy=p2.y-p1.y,
                              c=Math.sqrt(dx*dx+dy*dy),
                              deg;
                          deg=(c>0) ? Math.asin(dy/c)/(Math.PI/180) : 0;
                          deg=(dx>0) ? deg : 180-deg;  
                          return (deg).toFixed(2); 
                        }

                        init = function() {
                          var arrows = document.getElementsByClassName('arrow');

                          for (var i = 0; i < arrows.length; i++) {
                            (function() {
                              arrows[i].remove();
                            })()
                          };
                          console.log("started")
                          var models = document.getElementsByClassName('model');
                          var belongsTo, hasMany, modelName;
                          for (var i =0; i < models.length; i++) {
                            belongsTo = models[i].dataset.belongsto
                            hasMany = models[i].dataset.hasmany
                            modelName = models[i].dataset.model
                            var divFrom = models[i]

                            if (hasMany.length !== 0) {
                              // name is pluralized so remove s to search
                              var toName = hasMany.split(" ")[0].slice(0, -1);
                              var divTo = document.querySelectorAll("[data-model='"+toName+"']")[0]

                              var divFromCoords = divFrom.getBoundingClientRect()
                              var divToCoords = divTo.getBoundingClientRect()

                              // need to figure out where to put arrow,
                              // if the model from is above model to, then we aim for top of container
                              // if model from is below to (via top in coords), aim for the bottom of the model container
                              var newArrow = document.createElement("div"); 
                              newArrow.className += "arrow"
                              newArrow.className += " " + modelName + "_to_" + toName
                              newArrow.style.top = divFromCoords.top + "px";
                              newArrow.style.left = (divFromCoords.left + divFromCoords.width/2) + "px"
                              newArrow.style.bottom = divFromCoords.bottom + "px"
                              newArrow.style.right = divFromCoords.right + "px";
                              var distanceForArrow = Math.abs(divFromCoords.left - divToCoords.right) - divFromCoords.width/2+ "px"
                              var prefixTransform = "transform";

                              var deg = angle({"x": divFromCoords.left,
                                             "y": divFromCoords.top
                                            }, 
                                          {"x": divToCoords.left, 
                                           "y": divToCoords.top
                                          });

                              newArrow.style[prefixTransform]="rotate(" + deg + "deg)";
                              newArrow.style.width = distanceForArrow;
                              
                              document.body.appendChild(newArrow);

                              if (divFromCoords.top > divToCoords.top) {
                                // arrow needs to point down
                                
                              } else {
                                // arrow needs to point up
                              }                              
                            }
                            console.log("modelName: " + modelName + " with belongsTo " + belongsTo + " and hasMany " + hasMany );
                          }
                          console.log('finished')
                        }

                        window.onresize = init

                        init()
                      </script>
                      </body></html>